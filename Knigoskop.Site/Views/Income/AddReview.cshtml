@using System.Web.UI.WebControls
@{
    var title = !string.IsNullOrEmpty(ViewBag.IncomeId) ? Text.EditReviewTitle : Text.AddReviewTitle;
    ViewBag.Title = string.Format("{0} | {1}", title, Text.ProjectName);
    Layout = "~/Views/Shared/_Layout.cshtml";

}
<script src="~/Scripts/knockout-2.3.0.debug.js"></script>
<script src="~/Scripts/Ajaxupload.js"></script>
<script src="~/Scripts/knockout.extensions.js"></script>
@*<script src="~/Scripts/ckeditor/ckeditor.js"></script>*@
<h2 style="margin-top:20px;"><span>@title</span></h2>
<script type="text/javascript">
    function IncomeReviewModel() {

        var self = this;
        this.Id = ko.observable('@ViewBag.IncomeId');
        this.BookId = ko.observable('@ViewBag.BookId');
        this.Name = ko.observable().extend({ required: "@Text.RequiredFieldMessage" });
        this.Description = ko.observable().extend({ required: "@Text.RequiredFieldMessage" });
        this.Rating = ko.observable().extend({ required: "@Text.RequiredFieldMessage" });
        this.RatingClass = function (rating) {
            return ko.computed(function () {
                return rating <= self.Rating() ? "star filled" : "star empty"
            }, this);

        }
        InitValidation(this);
        this._isDataLoaded = ko.observable(false);
        this._isDataSaved = ko.observable(false);
        InitValidation(this);
        this.ChangeRating = function (rating) {
            self.Rating(rating);
        }
        this.Load = function () {
            $.getJSON("/income/LoadReview/?incomeId=" + self.Id(), function (data) {
                self.Description(data.Description);
                self.Name(data.Name);
                self.Rating(data.Rating);
                self.BookId(data.BookId);
                self._isDataLoaded(true);
            })
        };
        this.Save = function () {
            var valid = self.IsValid()
            if (valid) {
                var data = ko.toJSON(self)
                $.ajax({
                    type: 'POST',
                    url: '/income/savereview/?isincome=@ViewBag.IsIncome',
                    cache: false,
                    contentType: 'application/json; charset=utf-8',
                    data: data,
                    success: function () {
                        self._isDataSaved(true);
                    }
                });

            }
        }
        this.goBack = function () {
            var returnUrl = '@Url.Action("Book", "Catalogue", new { id = ViewBag.BookId })';
            if ('@Request.Params["returnUrl"]' != '')
                returnUrl = '@Request.Params["returnUrl"]';
            window.location = returnUrl;
        }
    }
    var viewModel = new IncomeReviewModel();
    $(function () {
        if (viewModel.Id().length > 0) {
            viewModel.Load();
        }
        else {
            viewModel._isDataLoaded(true);
        }

        ko.applyBindings(viewModel);
    });
</script>
<!-- ko if: _isDataSaved()==false -->
<div class="view" data-bind="visible: _isDataLoaded()" style="display: none;">
    <div class="section-review">
        <div class="field-content">
            <div class="field-title">@Text.ReviewRating</div>
            <span class="rating live large client">

                <span data-bind="attr: { class: RatingClass(5)} , click:function(){ ChangeRating(5)}" title="5"></span>
                <span data-bind="attr: { class: RatingClass(4)} , click:function(){ ChangeRating(4)}" title="4"></span>
                <span data-bind="attr: { class: RatingClass(3)} , click:function(){ ChangeRating(3)}" title="3"></span>
                <span data-bind="attr: { class: RatingClass(2)} , click:function(){ ChangeRating(2)}" title="2"></span>
                <span data-bind="attr: { class: RatingClass(1)} , click:function(){ ChangeRating(1)}" title="1"></span>


            </span>
            <span data-bind='visible: Rating.hasError, text: Rating.validationMessage'></span>
        </div>
        <div class="field-content">
            <div class="field-title">@Text.ReviewName</div>
            <input type="text" data-bind="value: Name" />
            <span data-bind='visible: Name.hasError, text: Name.validationMessage'></span>
        </div>
        <div class="field-content">
            <div class="field-title">@Text.ReviewDescription</div>
            @*<textarea id="txtDescription" rows="8" data-bind="ckEditor: Description"></textarea>*@
            <textarea id="txtDescription" rows="8" data-bind="value: Description"></textarea>
            <span data-bind='visible: Description.hasError, text: Description.validationMessage'></span>
        </div>

    </div>
    <input type="button" value="@Text.Save" class="yellow-button" data-bind='click: $root.Save' />
</div>

@{
    Html.RenderPartial("~/Views/Income/IncomeShared.cshtml");
}


